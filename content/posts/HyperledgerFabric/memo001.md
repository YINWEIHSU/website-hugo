---
title: "[FABRIC] Hyperledger Fabric"
date: 2022-12-07T16:15:01+08:00
draft: true
---
# Hyperledger Fabric的組成
Hyperledger Fabric有三個組要的組成元素。
1. 成員管理（membership service）
*  Hyperledger Fabric CA 是fabric提供的成員管理服務（頒發證書），但不一定要使用，只要是可以頒發EC證書的（基於X509的PKI）都可以使用。
* Identity Mixer目前還沒用到，可繼續研究。
2. 排序節點（Dedicated orderer nodes）
* 將新創建的塊廣播至區塊鏈網路中。
* Hyperledger Fabric 提供了三種類型的排序——Solo（用於開發測試）、Raft（用於生產）和具有高容錯性的Kafka。
* 排序服務是可插拔的——實施者只需要提供一個基於 gRPC 接口定義的原子廣播 API（ atomic-broadcast API）
![Eager update everywhere with distributed locking](/HyperledgerFabric/sample.png)
3. 節點（Peers）
用來執行智能合約，並維護帳本
* 背書交易（Endorsement）（執行但不提交）
* 從排序節點接收批量背書交易，然後驗證和提交交易（消除非確定性）

# Hyperledger Fabric的設計原則
1. 可模組化以及可擴展性：包含但不限於以下的模塊
* 共識層
* 合約（chaincode）層
* 溝通（gossip）層
* 資料儲存
* 身份服務
* 可插拔密碼學

2. 操作互通性：提供向後操作性，但並非提供不同hyperledger專案彼此之間的互操作亦不包含與不同區塊鏈網路之間的互操作性。
3. 安全的解決方案:企業和業務網路之間的安全性是最重要的。
4. 不被察覺的token：Hyperledger 項目不使用加密資產、加密貨幣、令牌或類似代幣的結構作為建立信任系統的激勵機制。 雖然其存在資產代幣化概念，但資產代幣化與作為激勵而生成的系統代幣是一個截然不同的概念。
5. 豐富且易操作的API:：確保區塊鏈網路可以串接企業的系統或商業網路，但不會暴露本身的區塊鏈網路系統。

# Hyperledger Fabric 的參考架構
下面列出一些架構中的重要元件。
1. 會員服務（Membership services）：此模組為區塊鏈網路創建之時建立根憑證(root of trust)的工具，也可以用來確保管理員的身份。會員服務本身為一個證書頒發機構，利用PKI來進行私鑰發送、管理，利用Hyperledger Fabric 提供的加密功能來向網路中的成員頒發證書。
2. 交易（Transactions）：交易本身是個向區塊鏈發起的請求，用來執行帳本上的函式。此函式由合約來執行，透過密碼學去驗證鏈上的哈希值驗證交易的完整性。
3. 通道（Channel）：一個Fabric區塊鏈網路中可以有很多條通道，每一個通道擁有各自的帳本、共識協議、合約們、加入規則，節點們等。
4. 狀態資料庫（State database）：狀態資料庫也被稱為世界狀態（World state），儲存帳本目前的狀態。而與帳本不同的是，帳本儲存完整的交易紀錄，而世界狀態儲存過去排序的歷史交易所呈現的最新狀態。且合約透過他來查詢帳本的最新狀態，資料庫有兩個選擇。
* LevelDB：默認的內建鍵值對資料庫，支援鍵查詢，組合鍵查詢以及範圍鍵查詢。
* CouchDB：除了上面的功能外，也支援rich-query以及index。
5. 合約服務（Contract Service）：合約作為交易的一部分，是個儲存在帳本上的應用程式級程式碼。鏈碼執行的交易會改變世界狀態，交易邏輯是透過在安全容器中執行的合約來執行。交易轉換數據，範圍由通道中運行的合約決定。而合約實際上是安裝在節點上，需要訪問資產狀態才能進行讀寫操作。合約在特定通道和對等節點上被實例化。 在一個通道內，合約可以在所有節點之間共享，也可以與特定子集合共享。
6. 事件（Events）：在驗證節點或合約的過程會產生事件（預定義的通道事件和合約生成的自定義事件），應用程式可以監聽這些事件並對其產生相對應的行動。這些事件可以透過WebHooks 或 Kafka 等工具進行傳遞。通道提供事件服務功能已將事件流發不給註冊的事件監聽器。從2.0版本開始，包含了提交區塊（區塊事件）、交易以及發出交易、特定於組織的私有數據、僅限於確認特定交易的過濾等事件。每當一個塊被提交到賬本時，就會發布一個事件。
7. 共識（Consensus）：共識是區塊鏈系統的核心。通常，共識服務允許網路中的成員提出並認證經過數位簽章的交易。 在Hyperledger Fabric中，共識是可插入的，並與 Hyperledger 提出的endorse-order-validate模型緊密相關。 Hyperledger Fabric透過排序服務來實行共識系統。 排序服務將多個交易分批放入塊中，並透過哈希值串上區塊鏈。
8. 帳本（Ledger）：加密分布式帳本，透過append-only資料結構來實現。每個節點都分別維護自己所屬通道的帳本副本。
9. 加密資料（Private data）：加密資料允許組織在帳本上儲存加密的資料，資料儲存在授權節點上的加密狀態資料庫中，可以透過有權限的節點上的合約去存取。
10. SDK：客戶端的SDK允許使用者部署和調用在帳本上的交易。目前支援Node.js以及Java（Go, Python開發中）。

# Hyperledger Fabric 的運行架構
1. 交易提交（Transaction proposal）（透過客戶端SDK）：交易透過客戶端SDK提交，並同時將交易送往通道中每個被設計參與共識的背書節點（endorsing peers）。
2. 背書交易（Transaction endorsement）：每個背書節點透過合約執行交易並回簽執行結果。結果是用交易的讀寫集（read-write set）的形式存在。此結果（包含讀寫集）會被回傳至SDK。每個節點可能同時執行多筆交易，甚至是來自不同通道的交易，支援併發執行。
3. 提交交易至排序服務（Transaction submitted to the ordering service）：SDK將收到的已背書交易提案提交至排序服務。排序服務接受背書交易並將交易排序放進區塊中，接著將區塊傳送給所有在通道中的節點。
4. 交易驗證（Transaction validation）：節點收到區塊後會先進行驗證，節點會驗證背書政策（endorsement policy）以及狀態資料庫中讀寫集的讀取部分。經過驗證後，該區塊會被提交到帳本上，而交易會被提交到狀態資料庫。

## 節點種類
1. 承諾節點（Committing peer）：用來維護帳本以及狀態，負責提交交易，但不一定要安裝合約。
2. 背書節點（Endorsing peer）：一個特別的承諾節點，可以授予或拒絕對交易提案的背書。需要持有智能合約。
3. 排序節點（Ordering node）：與前兩種節點溝通，負責允許包含交易的區塊提交至帳本，不用持有合約。

## 驗證
驗證由兩種角色來執行。
1. 背書（Endorsing）：確認交易並沒有違反智能合約，透過簽署教署來完成背書的驗證。
2. 排序（Ordering）：驗證準備提交至帳本的交易，用來控制可提交至帳本上的交易並確保一致性。